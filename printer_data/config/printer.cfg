#############################################################################################################
### CONFIGURATION GENERATED BY THE RATOS CONFIGURATOR
### Everything below [include RatOS.cfg] will override default RatOS behavior
#############################################################################################################
[include RatOS.cfg]
#[include filament_sensor.cfg]
[include Orbiter2_SmartSensor.cfg]
#[include spoolman.cfg]

#############################################################################################################
### MACRO CONFIGURATION
### Configure the behavior of RatOS macros
### See: https://os.ratrig.com/docs/configuration/macros
#############################################################################################################
[gcode_macro RatOS]
variable_relative_extrusion: True
variable_preheat_extruder: True
variable_calibrate_bed_mesh: True
variable_nozzle_priming: "primeblob"
variable_start_print_park_in: "primeblob"
variable_start_print_park_z_height: 50
variable_end_print_park_in: "back"
variable_pause_print_park_in: "front"
variable_beacon_adaptive_heat_soak: True
variable_beacon_adaptive_heat_soak_layer_quality: 3
variable_beacon_adaptive_heat_soak_maximum_first_layer_duration: 1800
variable_beacon_adaptive_heat_soak_max_wait: 2000
variable_beacon_adaptive_heat_soak_extra_wait_after_completion: 10
variable_beacon_scan_compensation_enable: True                            # Enables beacon scan compensation
variable_beacon_scan_compensation_profile: "auto"                         # Use "auto" for automatic selection based on bed temperature, or specifiy the profile name of a
                                                                          # previously created compensation mesh. If two compensation meshes exist for the same bed temperature,
                                                                          # "auto" cannot be used and a specific profile name must be specified.
variable_beacon_contact_start_print_true_zero: True                       # Uses contact to determine true Z=0 during START_PRINT
variable_beacon_contact_start_print_true_zero_fuzzy_position: True        # Randomizes true zero position to avoid wear marks
variable_beacon_contact_calibrate_model_on_true_zero: False               # Calibrate a new beacon model when performing True Zero.
                                                                          # This is the recommended workflow.
variable_beacon_contact_wipe_before_true_zero: True                       # Enables nozzle wipe before true zeroing
variable_beacon_contact_true_zero_temp: 170                               # Nozzle temperature for true zeroing
                                                                          # WARNING: If using a smooth PEI sheet, be careful with temperature

#############################################################################################################
### USER OVERRIDES & CUSTOM CONFIGURATION
### Anything custom you want to add, or RatOS configuration you want to override, do it here.
### This section is pre-populated with the most common settings you may want to change.
### See: https://os.ratrig.com/docs/configuration/includes-and-overrides
###
### It is recommended that you follow these steps to properly calibrate your printer:
### 0) Sanity check and PID Tuning: https://www.klipper3d.org/Config_checks.html
### 1) Z-offset calibration: run BEACON_RATOS_CALIBRATE to automatically calibrate your beacon for scan and contact.
###    IMPORTANT: Ensure the beacon is properly mounted and the nozzle and meltzone is clean by unloading
###    the filament (if it's loaded) and make sure there's no ooze or gunk on the nozzle when the hotend is at printing temperature.
### 2) Pressure Advance: https://www.klipper3d.org/Pressure_Advance.html
### 3) Skew Correction: https://www.klipper3d.org/Skew_Correction.html
### 4) Resonance Compensation: https://www.klipper3d.org/Resonance_Compensation.html
### RatOS has dedicated macro's to generate shaper graphs for deeper analysis (requires accelerometer).
### Use MEASURE_COREXY_BELT_TENSION to compare tension between belts, and use
### GENERATE_SHAPER_GRAPHS to generate the resonance graphs for analysing and manually entering input shaper
### configuration.
### You can run SHAPER_CALIBRATE to automatically calibrate your input shaper configuration, if you just want
### to get started.
### Additionally, you can use the Realtime Analysis Tool to analyze your printer's performance in real-time.
### Read more about klipper here: https://www.klipper3d.org/Overview.html
#############################################################################################################

#---------------------------------------------------- X -----------------------------------------------------
# The A motor in the CoreXY system, located at the rear left of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_x]
dir_pin: x_dir_pin                # Add ! in front of pin name to reverse the direction of stepper_x
rotation_distance: 40             # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
position_min: -59.6
position_max: 557.8
position_endstop: -59.6

#---------------------------------------------------- Y -----------------------------------------------------
# The B motor in the CoreXY system, located at the rear right of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_y]
dir_pin: y_dir_pin                # Add ! in front of pin name to reverse the direction of stepper_y
rotation_distance: 40             # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
position_min: -14.35
position_max: 530
position_endstop: -14.35

#---------------------------------------------------- Z -----------------------------------------------------
# The left Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z]
dir_pin: !z0_dir_pin              # Remove ! in front of pin name to reverse the direction of stepper_z
rotation_distance: 4              # 4 for TR8*4 lead screws
homing_speed: 10
position_min: -5
position_max: 500

#---------------------------------------------------- Z1 ----------------------------------------------------
# The rear Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z1]
dir_pin: !z1_dir_pin              # Remove ! in front of pin name to reverse the direction of stepper_z1
rotation_distance: 4              # 4 for TR8*4 lead screws

#---------------------------------------------------- Z2 ----------------------------------------------------
# The right Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z2]
dir_pin: !z2_dir_pin              # Remove ! in front of pin name to reverse the direction of stepper_z2
rotation_distance: 4              # 4 for TR8*4 lead screws

#------------------------------------------------- EXTRUDER -------------------------------------------------
# The extruder motor used for pushing filament through the toolhead
#------------------------------------------------------------------------------------------------------------
[extruder]
dir_pin: toolboard_t0:e_dir_pin   # Add ! in front of pin name to reverse the direction of extruder
rotation_distance: 4.63           # Orbiter 2 default
pressure_advance:  0.03           # Check https://www.klipper3d.org/Pressure_Advance.html for pressure advance tuning.
#control: pid
#pid_kp: 28.413
#pid_ki: 1.334
#pid_kd: 151.300


[heater_bed]
#control: pid
#pid_Kp: 22.2
#pid_Ki: 1.08
#pid_Kd: 114

#################################
## Spoolman
#################################
[gcode_macro SET_ACTIVE_SPOOL]
gcode:
  {% if params.ID %}
    {% set id = params.ID|int %}
    {action_call_remote_method(
       "spoolman_set_active_spool",
       spool_id=id
    )}
  {% else %}
    {action_respond_info("Parameter 'ID' is required")}
  {% endif %}

[gcode_macro CLEAR_ACTIVE_SPOOL]
gcode:
  {action_call_remote_method(
    "spoolman_set_active_spool",
    spool_id=None
  )}

# REMEMBER TO CALIBRATE YOUR BEACON!
# Run BEACON_RATOS_CALIBRATE for automatic calibration.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [beacon model default]
#*# model_coef = 1.5425993161746274,
#*# 	1.910537570854115,
#*# 	0.8420985125684163,
#*# 	0.42861450730774153,
#*# 	0.21901386535504994,
#*# 	-0.02409768574394339,
#*# 	-0.1813664298075122,
#*# 	0.03338425866778039,
#*# 	0.17778110612551093,
#*# 	0.05535517838588584
#*# model_domain = 1.8561093992803047e-07,1.9359798221239904e-07
#*# model_range = 0.200104,5.000104
#*# model_temp = 43.604724
#*# model_offset = 0.00000
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 66.0
#*# shaper_type_y = zv
#*# shaper_freq_y = 32.0
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 39.282
#*# pid_ki = 9.699
#*# pid_kd = 39.774
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 58.713
#*# pid_ki = 1.747
#*# pid_kd = 493.186
#*#
#*# [beacon_user_z_offset]
#*# z_offset = 0.0000
